# 数据库优化与大数据量

## 1.MySQL调优

MySQL数据库是常见的两个瓶颈是CPU和I/O的瓶颈，CPU在饱和的时候一般发生在数据装入内存或从磁盘上读取数据时候。磁盘I/O瓶颈发生在装入数据远大于内存容量的时候。对于MySQL系统本身，可以使用工具来优化数据库的性能，通常有三种：使用索引，使用EXPLAIN分析查询以及调整MySQL的内部配置。

在优化MySQL时，通常需要对数据库进行分析，常见的分析手段有**慢查询日志**，**EXPLAIN 分析查询**，**profiling分析**以及show命令查询系统状态及系统变量，通过定位分析性能的瓶颈，才能更好的优化数据库系统的性能。

通过慢日志查询可以知道哪些SQL语句执行效率低下，通过explain我们可以得知SQL语句的具体执行情况，索引使用等，还可以结合show命令查看执行状态。

**通过explain命令可以得到:**

- 表的读取顺序
- 数据读取操作的操作类型
- 哪些索引可以使用
- 哪些索引被实际使用
- 表之间的引用
- 每张表有多少行被优化器查询

如果觉得explain的信息不够详细，可以同通过profiling命令得到更准确的SQL执行消耗系统资源的信息。

## 2.MySQL 对于千万级的大表要怎么优化

**可依次进行以下优化：**

- 优化SQL和索引
- 应用缓存机制 (memcached,redis)
- 进行主从复制或主主复制，读写分离
- 应用MySQL自带的分区表
- 垂直拆分
- 水平拆分

## 3.MySQL数据库复制（主从、主主）

#### MySQL复制解决的问题

- 数据分布
- 负载平衡
- 备份
- 高可用性和容错行

#### 主从复制：

![105353509.jpg](http://jbcdn2.b0.upaiyun.com/2015/11/8412e33ef81f950e8052fafad041731c.jpg)

**主从复制的原理：**

分为同步复制和异步复制，实际复制架构中大部分为异步复制。 复制的基本过程如下：

1).Slave上面的IO进程连接上Master，并请求从指定日志文件的指定位置（或者从最开始的日志）之后的日志内容；

2).Master接收到来自Slave的IO进程的请求后，通过负责复制的IO进程根据请求信息读取制定日志指定位置之后的日志信息，返回给Slave 的IO进程。返回信息中除了日志所包含的信息之外，还包括本次返回的信息已经到Master端的bin-log文件的名称以及bin-log的位置；

3).Slave的IO进程接收到信息后，将接收到的日志内容依次添加到Slave端的relay-log文件的最末端，并将读取到的Master端的 bin-log的文件名和位置记录到master-info文件中，以便在下一次读取的时候能够清楚的告诉Master“我需要从某个bin-log的哪个位置开始往后的日志内容，请发给我”；

4).Slave的Sql进程检测到relay-log中新增加了内容后，会马上解析relay-log的内容成为在Master端真实执行时候的那些可执行的内容，并在自身执行。

**对于主从复制，Mysql数据库的版本，两个数据库版本要相同，或者slave比master版本低。**

#### 主主复制

互为对方的从服务器，每台服务器即是对方的主服务器，又是对方的从服务器。但可能会面对主键重复等问题。